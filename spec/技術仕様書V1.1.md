# 計算スプリント 技術仕様書（追記 v1.1）

## 目的（v1.1）

v1.0 で実装した「速度 × 正確性」の可視化を一段階進め、
**現場での導入スピード向上**と**次の指導アクションが即座に判断できる状態**を作る。

v1.1 では以下の3点のうち、**①プリセット機能を必須**、②③は拡張余地として定義する。

---

## v1.1 機能一覧

### ① 難易度プリセット（必須）

#### 機能概要

* 学年・レベル別に、設定（mode / digit / carry）をまとめた「プリセット」を選択できる
* 設定画面で **ラジオボタン or セレクトボックス 1つ**で反映
* プリセット選択後も、手動で微調整できる（上書き可能）

#### 目的

* 教師・支援員が設定を考える時間を削減
* 子どもを待たせず、即スタートできる

#### 想定プリセット例（固定）

| key        | 表示名       | mode    | digit | carry |
| ---------- | --------- | ------- | ----- | ----- |
| p3-basic   | 小3 基本     | add/sub | 1     | false |
| p4-nocarry | 小4 繰上がりなし | add/sub | 2     | false |
| p4-carry   | 小4 繰上がりあり | add/sub | 2     | true  |
| p5-mul     | 小5 九九     | mul     | 1     | true  |
| mix-basic  | ミックス      | mix     | 1     | true  |

※ mode が複数の場合は内部的に mix 扱いで、対象演算のみ出題

---

### ② 平均回答時間（v1.2・必須）

#### 機能概要

* 各問題の回答時間を計測し、結果画面に **平均○.○秒/問** を表示する
* 計測は **「問題を表示した瞬間」→「Enterで確定した瞬間」** の差分
* フィードバック表示（0.5秒）は **回答時間に含めない**（含めると遅く見えるため）

#### 目的

* 「速度」を数値で見える化し、成長が実感できる
* 反復練習の動機付け（ゲーム性）を強化

#### 仕様（v1.2）

* gameState に以下を追加

  * `totalAnswerTimeMs`（累計回答時間）
  * `questionStartAtMs`（出題開始時刻）
  * `answeredCountForTiming`（平均計算の分母：通常 totalAnswered と同じでよい）
* gameScreen

  * `loadNextQuestion()` で `questionStartAtMs = performance.now()` をセット
  * `submitAnswer()` 冒頭で `elapsed = now - questionStartAtMs` を算出し、`totalAnswerTimeMs += elapsed`
  * 空欄/NaN/ロック中/タイムアップ後など **「回答として扱わないケース」では加算しない**
* resultScreen

  * `avgSec = totalAnswerTimeMs / answeredCountForTiming / 1000`
  * 表示は小数1桁（例：`3.4`）

---

### ③ ミス傾向の可視化（v1.3・必須）

#### 機能概要

* mode（add/sub/mul/div）ごとに **不正解数** を集計し、結果画面に表示する
* questionGenerator が返す `meta.mode` を利用する
* mode が `mix` の場合でも、`meta.mode` は必ず add/sub/mul/div のいずれかになる前提

#### 目的

* 「どの計算で崩れているか」を即把握し、指導・復習に繋げる
* 速度（平均秒/問）と合わせて、次の学習方針を決められる

#### 仕様（v1.3）

* gameState に以下を追加

  * `wrongByMode`: `{ add: 0, sub: 0, mul: 0, div: 0 }`
  * （任意）`attemptByMode`: `{ add: 0, sub: 0, mul: 0, div: 0 }`（将来のモード別正答率等に備える）

* gameScreen

  * `enter()` で `wrongByMode`（と `attemptByMode`）を初期化
  * `submitAnswer()` で `const m = gameState.currentQuestion?.meta?.mode` を取得

    * 回答扱いのとき `attemptByMode[m]++`（任意）
    * 不正解なら `wrongByMode[m]++`
  * `m` が add/sub/mul/div 以外、または欠損なら安全にスキップ（キー存在を明示チェック）

* questionGenerator

  * 返り値は `{ text, answer, meta }`
  * `meta.mode` を必ず add/sub/mul/div のいずれかにする
  * `settings.mode === 'mix'` の場合は内部で選ばれた mode を `meta.mode` に入れる

* resultScreen

  * 結果画面に「ミス内訳（加/減/乗/除）」を表示
  * 表示は最小でOK（例：`加:1 / 減:0 / 乗:2 / 除:0`）

## 画面仕様変更（v1.1）

### 設定画面（settings-screen）

#### 追加UI

* プリセット選択欄

  * label: 「難易度プリセット」
  * input: select または radio

#### 挙動

1. プリセット選択
2. 対応する settings（mode/digit/carry）を gameState.settings に反映
3. 既存の個別設定UI（mode/digit/carry）も同時に更新される

---

## データ構造（追加/変更）

### presets 定義（新規）

```js
const PRESETS = {
  p3-basic: { mode: 'mix', allowedModes: ['add','sub'], digit: 1, carry: false },
  p4-nocarry: { mode: 'mix', allowedModes: ['add','sub'], digit: 2, carry: false },
  p4-carry: { mode: 'mix', allowedModes: ['add','sub'], digit: 2, carry: true },
  p5-mul: { mode: 'mul', digit: 1, carry: true },
};
```

※ allowedModes は questionGenerator 側で参照してもよい（v1.1では必須ではない）

---

## 非対応（v1.1ではやらない）

* データ保存（localStorage / DB）
* ランキング
* 効果音・演出追加
* スマホUI最適化

---

## v1.1 完了条件

* プリセットを選ぶだけで適切な設定が反映される
* 既存の v1.0 機能（タイマー/フィードバック/結果表示）が壊れていない
* 設定→ゲーム→結果→リトライ/戻る が従来どおり動作
