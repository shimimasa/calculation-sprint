# 計算スプリント 技術仕様書（追記 v1.1）

## 目的（v1.1）

v1.0 で実装した「速度 × 正確性」の可視化を一段階進め、
**現場での導入スピード向上**と**次の指導アクションが即座に判断できる状態**を作る。

v1.1 では以下の3点のうち、**①プリセット機能を必須**、②③は拡張余地として定義する。

---

## v1.1 機能一覧

### ① 難易度プリセット（必須）

#### 機能概要

* 学年・レベル別に、設定（mode / digit / carry）をまとめた「プリセット」を選択できる
* 設定画面で **ラジオボタン or セレクトボックス 1つ**で反映
* プリセット選択後も、手動で微調整できる（上書き可能）

#### 目的

* 教師・支援員が設定を考える時間を削減
* 子どもを待たせず、即スタートできる

#### 想定プリセット例（固定）

| key        | 表示名       | mode    | digit | carry |
| ---------- | --------- | ------- | ----- | ----- |
| p3-basic   | 小3 基本     | add/sub | 1     | false |
| p4-nocarry | 小4 繰上がりなし | add/sub | 2     | false |
| p4-carry   | 小4 繰上がりあり | add/sub | 2     | true  |
| p5-mul     | 小5 九九     | mul     | 1     | true  |
| mix-basic  | ミックス      | mix     | 1     | true  |

※ mode が複数の場合は内部的に mix 扱いで、対象演算のみ出題

---

### ② 平均回答時間（v1.2・必須）

#### 機能概要

* 各問題の回答時間を計測し、結果画面に **平均○.○秒/問** を表示する
* 計測は **「問題を表示した瞬間」→「Enterで確定した瞬間」** の差分
* フィードバック表示（0.5秒）は **回答時間に含めない**（含めると遅く見えるため）

#### 目的

* 「速度」を数値で見える化し、成長が実感できる
* 反復練習の動機付け（ゲーム性）を強化

#### 仕様（v1.2）

* gameState に以下を追加

  * `totalAnswerTimeMs`（累計回答時間）
  * `questionStartAtMs`（出題開始時刻）
  * `answeredCountForTiming`（平均計算の分母：通常 totalAnswered と同じでよい）
* gameScreen

  * `loadNextQuestion()` で `questionStartAtMs = performance.now()` をセット
  * `submitAnswer()` 冒頭で `elapsed = now - questionStartAtMs` を算出し、`totalAnswerTimeMs += elapsed`
  * 空欄/NaN/ロック中/タイムアップ後など **「回答として扱わないケース」では加算しない**
* resultScreen

  * `avgSec = totalAnswerTimeMs / answeredCountForTiming / 1000`
  * 表示は小数1桁（例：`3.4`）

---

### ③ ミス傾向の可視化（v1.3・必須）

#### 機能概要

* mode（add/sub/mul/div）ごとに **不正解数** を集計し、結果画面に表示する
* questionGenerator が返す `meta.mode` を利用する
* mode が `mix` の場合でも、`meta.mode` は必ず add/sub/mul/div のいずれかになる前提

#### 目的

* 「どの計算で崩れているか」を即把握し、指導・復習に繋げる
* 速度（平均秒/問）と合わせて、次の学習方針を決められる

#### 仕様（v1.3）

* gameState に以下を追加

  * `wrongByMode`: `{ add: 0, sub: 0, mul: 0, div: 0 }`
  * （任意）`attemptByMode`: `{ add: 0, sub: 0, mul: 0, div: 0 }`（将来のモード別正答率等に備える）

* gameScreen

  * `enter()` で `wrongByMode`（と `attemptByMode`）を初期化
  * `submitAnswer()` で `const m = gameState.currentQuestion?.meta?.mode` を取得

    * 回答扱いのとき `attemptByMode[m]++`（任意）
    * 不正解なら `wrongByMode[m]++`
  * `m` が add/sub/mul/div 以外、または欠損なら安全にスキップ（キー存在を明示チェック）

* questionGenerator

  * 返り値は `{ text, answer, meta }`
  * `meta.mode` を必ず add/sub/mul/div のいずれかにする
  * `settings.mode === 'mix'` の場合は内部で選ばれた mode を `meta.mode` に入れる

* resultScreen

  * 結果画面に「ミス内訳（加/減/乗/除）」を表示
  * 表示は最小でOK（例：`加:1 / 減:0 / 乗:2 / 除:0`）

## 画面仕様変更（v1.1）

### 設定画面（settings-screen）

#### 追加UI

* プリセット選択欄

  * label: 「難易度プリセット」
  * input: select または radio

#### 挙動

1. プリセット選択
2. 対応する settings（mode/digit/carry）を gameState.settings に反映
3. 既存の個別設定UI（mode/digit/carry）も同時に更新される

---

## データ構造（追加/変更）

### presets 定義（新規）

```js
const PRESETS = {
  p3-basic: { mode: 'mix', allowedModes: ['add','sub'], digit: 1, carry: false },
  p4-nocarry: { mode: 'mix', allowedModes: ['add','sub'], digit: 2, carry: false },
  p4-carry: { mode: 'mix', allowedModes: ['add','sub'], digit: 2, carry: true },
  p5-mul: { mode: 'mul', digit: 1, carry: true },
};
```

※ allowedModes は questionGenerator 側で参照してもよい（v1.1では必須ではない）

---

## 非対応（v1.1ではやらない）

* データ保存（localStorage / DB）
* ランキング
* 効果音・演出追加
* スマホUI最適化

---

## v1.1 完了条件

* プリセットを選ぶだけで適切な設定が反映される
* 既存の v1.0 機能（タイマー/フィードバック/結果表示）が壊れていない
* 設定→ゲーム→結果→リトライ/戻る が従来どおり動作

---

## v1.4（推奨）

v1.3 までで「速度（平均秒/問）」と「弱点（ミス内訳）」が揃った。
v1.4 では、現場での指導判断をさらに即決できるように、以下2点を追加する。

### ① モード別正答率（%）（必須）

#### 機能概要

* add/sub/mul/div それぞれについて、**正答率（%）**を結果画面に表示
* v1.3 で導入済みの `attemptByMode` と `wrongByMode` を利用して算出

#### 仕様

* 各モード m について

  * `attempt = attemptByMode[m]`
  * `wrong = wrongByMode[m]`
  * `correct = attempt - wrong`（0未満にならないよう `Math.max(0, ...)`）
  * `rate = attempt > 0 ? Math.round((correct / attempt) * 100) : 0`
* 結果画面の表示例（最小）

  * `加: 80% (4/5) / 減: 100% (3/3) / 乗: 0% (0/0) / 除: 50% (1/2)`

#### 注意

* attempt が 0 のときは `0% (0/0)` を表示

---

### ② ベスト平均回答時間（セッション内）（推奨）

#### 機能概要

* 現在の平均秒/問に加えて、**このページを開いている間（セッション内）のベスト（最小）平均秒/問**を表示
* 保存（localStorage）は v1.4 では行わない（セッション内のみ）

#### 仕様

* gameState に以下を追加

  * `bestAvgSecSession: null`（初期値）
* resultScreen.enter() で

  * `currentAvgSec` を算出（v1.2の avgSec）
  * `currentAvgSec > 0` のとき

    * `bestAvgSecSession === null` または `currentAvgSec < bestAvgSecSession` なら更新
* リトライで best をリセットしない（同セッション内の成長が見えるように）
* 設定に戻っても best は維持（ページリロードで消える）

---

## 非対応（v1.4ではやらない）

* 永続保存（localStorage / DB）
* 日付跨ぎ管理（「当日」判定）
* ランキング
* 音・演出強化

---

## v1.4 完了条件

* 結果画面にモード別正答率（% と 分数）が表示される
* 結果画面にベスト平均秒/問（セッション内）が表示される
* リトライでモード別集計はリセットされるが、bestAvgSecSession は維持される
* 既存の v1.0〜v1.3（タイマー/フィードバック/平均時間/ミス内訳）の挙動が壊れていない

---

## v1.5：復習モード（弱点優先出題）

### 概要

* 結果画面で「復習モード」を選択すると、**直前プレイでミスの多かった計算モードを優先して出題**する
* 教師・支援員がそのまま「じゃあここを練習しよう」と言える導線を作る

### 基本方針

* 永続保存は行わない（直前プレイのみ対象）
* UI/ロジックともに **最小実装**
* 通常プレイの挙動は一切変更しない

---

### 機能仕様

#### ① 復習対象モードの決定

* resultScreen.enter() 時点で、以下を算出

  * `reviewModes`: 不正解数が **1以上** の mode（add/sub/mul/div）の配列
* すべて 0 の場合

  * 復習モードは無効（ボタンを非表示 or disabled）

例：

* wrongByMode = { add:2, sub:0, mul:3, div:0 }
* reviewModes = ['add','mul']

---

#### ② 出題ロジック（復習モード中）

* gameState に以下を追加

  * `isReviewMode: false`
  * `reviewModes: []`

* 復習モード開始時

  * `gameState.isReviewMode = true`
  * `gameState.reviewModes = reviewModes`

* questionGenerator.next(settings) を拡張

  * `settings.reviewModes` が存在する場合

    * `mode` は `reviewModes` からランダムに選択
  * 存在しない場合は従来どおり

※ digit / carry / 既存制約はそのまま適用

---

#### ③ UI 仕様

##### 結果画面

* 「復習モードで再挑戦」ボタンを追加
* 表示条件

  * reviewModes.length > 0 のときのみ表示

##### 設定・タイトル画面

* 変更なし

---

#### ④ 状態リセットルール

* 復習モード開始時

  * 正解数 / ミス数 / 平均時間 等は **通常プレイと同様にリセット**
* 復習モード終了条件

  * リトライ or 設定に戻る を押した時点で

    * `isReviewMode = false`
    * `reviewModes = []`

---

## v1.5 完了条件

* ミスがある場合のみ、結果画面に「復習モード」ボタンが表示される
* 復習モードでは、ミスした mode のみが出題される
* 通常プレイの出題・設定挙動が壊れていない
* 復習モード終了後、通常プレイに戻る
* v1.0〜v1.4 の全機能が引き続き動作する

---

## v1.6：復習モードの段階終了（例：10問で終了）

### 概要

* 復習モードは「無限」ではなく、**指定問数を解いたら自動的に結果画面へ遷移**する
* 授業内での運用（5〜10分枠）に組み込みやすくする

### 仕様

#### ① 追加ステート（gameState）

* `reviewQuestionLimit: 10`（初期値）
* `reviewAnsweredCount: 0`

#### ② 復習開始時の初期化

* resultScreen の復習ボタン押下時（復習開始）に

  * `gameState.isReviewMode = true`
  * `gameState.reviewModes = reviewModes`
  * `gameState.reviewAnsweredCount = 0`

#### ③ カウントアップと自動終了（gameScreen）

* `submitAnswer()` で「回答扱い」のたびに

  * 復習モード中は `reviewAnsweredCount += 1`
* `reviewAnsweredCount >= reviewQuestionLimit` になったら

  * 以後の入力をロック
  * フィードバックtimeoutを解除
  * `screenManager.changeScreen('result')`

#### ④ 終了後の状態

* 結果画面に遷移した時点では、復習モード状態は維持してよい

  * ただし、

    * 「通常リトライ」または「設定に戻る」では従来どおり復習モード解除
    * 「復習モードで再挑戦」では `reviewAnsweredCount` を 0 に戻して再スタート

#### ⑤ UI（任意・推奨）

* game画面のステータスバーに

  * `復習: 3/10` のように進捗を表示（復習モードのときのみ）
* v1.6では必須ではないが、現場運用上は推奨

---

## v1.6 完了条件

* 復習モードで指定問数（デフォルト10問）を解くと、自動で結果画面へ遷移する
* 復習モード以外では、この制限が働かない
* 復習モードの再挑戦ではカウントが 0 に戻る
* v1.0〜v1.5 の全機能が引き続き動作する

---

## v1.7：復習完了メッセージ＋弱点コメント（指導につなげる）

### 概要

* 復習モードが上限到達で終了したとき、結果画面の上部に

  * 「おつかれ！」の完了メッセージ
  * 直前プレイ（復習モード中）の弱点に応じた短いコメント
    を表示する

### 目的

* ただ終わるのではなく、次の練習方針を即提示して授業に組み込む

---

### 仕様

#### ① 追加ステート（gameState）

* `reviewCompleted: false`
* `reviewSummary: { topMode: null, message: '' }`

#### ② 完了フラグの立て方（gameScreen）

* 復習モード中に上限到達して結果画面へ遷移する直前に

  * `gameState.reviewCompleted = true`
  * `gameState.reviewSummary = buildReviewSummary()`

※ 通常プレイの time-up / 終了では立てない

#### ③ サマリー生成（buildReviewSummary）

* 入力：`wrongByMode`, `attemptByMode`, `settings`（digit/carry も参照可）
* 出力：`{ topMode, message }`

ルール（最小）

* `topMode` = wrongByMode が最大の mode（同率なら add→sub→mul→div の優先順）
* wrong がすべて 0 の場合

  * message = "ミスが減ってきたね。次はスピードを意識しよう！"

弱点コメント例（固定文でOK）

* topMode === 'add'

  * message = "加算のミスが多め。まずは繰り上がりなしで正確に練習しよう。"
* topMode === 'sub'

  * message = "減算のミスが多め。繰り下がりなし→ありの順で練習しよう。"
* topMode === 'mul'

  * message = "かけ算のミスが多め。九九をゆっくり確実に言えるか確認しよう。"
* topMode === 'div'

  * message = "わり算のミスが多め。『かけ算に戻す』確認を入れて練習しよう。"

※ digit=2 かつ carry=true/false などに応じて文言を少し変えてもよいが、v1.7では固定文でよい

#### ④ 結果画面の表示（resultScreen / UI）

* result-screen の上部にメッセージ領域を追加（例：`result-review-banner`）
* 表示条件

  * `gameState.reviewCompleted === true` のときのみ表示
* 表示内容

  * 見出し：「おつかれ！」
  * 本文：`gameState.reviewSummary.message`

#### ⑤ リセット条件

* 以下の操作で reviewCompleted を false に戻す

  * 通常リトライ
  * 復習モードで再挑戦（再スタートなので一旦消す）
  * 設定に戻る
* 復習モード中の途中では消さない

---

## v1.7 完了条件

* 復習モードが上限到達で終了した場合のみ、結果画面に「おつかれ！」＋弱点コメントが表示される
* 通常プレイの結果では表示されない
* リトライ／復習再挑戦／設定戻りでメッセージがリセットされる
* v1.0〜v1.6 の全機能が引き続き動作する

---

## v1.8：弱点コメントから次の設定へ誘導（ワンクリック）

### 概要

* v1.7 の弱点コメントを「読むだけ」で終わらせず、
  **次にやるべき設定（例：繰り上がりなし加算）にワンクリックで移動**できる導線を追加する
* 教師・支援員が授業内で「じゃあ次はこれ」と即実行できる

### 仕様

#### ① サマリー拡張（reviewSummary）

* `reviewSummary` の構造を拡張

  * `nextAction: { label: string, presetPatch: Partial<settings> } | null`

例

* 加算が弱点の場合

  * label: "次は『繰り上がりなし（2桁）加算』で練習"
  * presetPatch: { mode: 'add', digit: 2, carry: false }

※ digit の推奨は、直前の settings.digit を優先してもよい（v1.8では固定でもOK）

#### ② コメント生成ルール（最小）

* topMode === 'add'

  * nextAction.label: "次は『繰り上がりなし（2桁）加算』で練習"
  * presetPatch: { mode:'add', digit:2, carry:false }
* topMode === 'sub'

  * label: "次は『繰り下がりなし（2桁）減算』で練習"
  * patch: { mode:'sub', digit:2, carry:false }
* topMode === 'mul'

  * label: "次は『九九（かけ算）』で練習"
  * patch: { mode:'mul', digit:1, carry:true }
* topMode === 'div'

  * label: "次は『わり算（割り切れる）』で練習"
  * patch: { mode:'div', digit:1, carry:true }
* wrongが全て0の場合

  * nextAction = null

#### ③ 結果画面UI

* 復習完了バナー内に「次へ」ボタン（またはリンク風ボタン）を追加

  * id例：`result-next-action-button`
  * 初期は hidden
* 表示条件

  * `reviewCompleted === true` かつ `reviewSummary.nextAction !== null`

#### ④ クリック挙動

* ボタン押下で

  1. `gameState.settings` を `presetPatch` で上書き
  2. 復習状態を解除（`isReviewMode=false`, `reviewModes=[]`, `reviewCompleted=false`）
  3. `screenManager.changeScreen('settings')` へ遷移
* settings 画面でその設定が反映されていること（applySettingsToUi が既にある想定）
* v1.8 では「プリセット選択UI」までは自動で合わせなくてよい（手動設定扱いに戻してOK）

#### ⑤ リセット

* v1.7 のリセット条件は維持
* nextAction ボタン押下時も reviewSummary を初期化してよい

---

## v1.8 完了条件

* 復習完了バナーが出ているとき、次の練習へ誘導するボタンが表示される
* クリックすると settings 画面に戻り、指定の設定が反映されている
* 通常プレイや復習モードの挙動が壊れていない
* v1.0〜v1.7 の全機能が引き続き動作する

---

## v2.0：日別の伸びを保存（localStorage）

### 概要

* ブラウザの localStorage に、日別の成績サマリを保存し、**成長が見える化**されるようにする
* アカウント/サーバ/個人情報は扱わない（端末内のみ）

### 目的

* 「今日は昨日より速い」「苦手が減った」が継続モチベになる
* 授業/支援の記録を“軽量”に残せる

---

### 保存するデータ（最小）

1日1レコード（YYYY-MM-DD）

* `bestAvgSec`：その日の最小平均秒/問
* `attemptTotal`：回答数合計（その日累計）
* `wrongTotal`：不正解数合計（その日累計）
* `wrongByMode`：{add,sub,mul,div}（その日累計）

※ 追加で `sessions`（実施回数）を持ってもよい

---

### localStorage 仕様

* キー：`calcSprint.daily.v1`
* 形式：JSON（オブジェクト）

例：

```json
{
  "2026-01-31": {
    "bestAvgSec": 2.8,
    "attemptTotal": 120,
    "wrongTotal": 15,
    "wrongByMode": {"add":5,"sub":4,"mul":6,"div":0},
    "sessions": 3
  }
}
```

---

### 更新タイミング

* `resultScreen.enter()` で結果を表示するたびに、その日のレコードを更新

* ただし、以下の条件でのみ「ベスト平均」を更新

  * `avgSec > 0` のとき
  * 既存 best がない、または `avgSec < bestAvgSec`

* `attemptTotal / wrongTotal / wrongByMode / sessions` は加算

---

### UI（最小）

結果画面の下部に「今日の記録」と「昨日との差」を表示（最小でOK）

* 今日

  * bestAvgSec（秒/問）
  * attemptTotal / wrongTotal
* 昨日との差（存在する場合のみ）

  * bestAvgSec の差（例：-0.3秒 改善）
  * wrongTotal の差（例：-2 減少）

※ グラフは不要（v2.1以降）

---

### 追加機能（任意）

* 「記録をリセット」ボタン

  * localStorage の `calcSprint.daily.v1` を削除
  * 誤操作防止のため confirm を挟む

---

### 非対応（v2.0ではやらない）

* サーバ保存 / 複数端末同期
* 個人情報の入力
* 詳細ログ（全問題の履歴）

---

## v2.0 完了条件

* result画面表示時に localStorage が日別に更新される
* result画面に「今日の記録」が表示される
* 昨日の記録がある場合「昨日との差」が表示される
* 既存の v1.0〜v1.8 の挙動が壊れていない

---

## v2.1：直近7日分の一覧表示（テーブル）

### 概要

* 結果画面に「直近7日分の記録一覧」を表示する
* グラフは不要。**表形式**で十分に伸びが見える

### 目的

* 「最近の傾向」を一目で把握できる
* 支援・授業での振り返りが速くなる

---

### 表示仕様（最小）

* 直近7日（今日を含む）を上から新しい順に表示

* 各行の列（最小）

  * 日付（YYYY-MM-DD）
  * bestAvgSec（秒/問）
  * attemptTotal（回答数）
  * wrongTotal（ミス数）

* 存在しない日（記録がない日）は表示しない（行を作らない）

---

### データ取得

* localStorage の `calcSprint.daily.v1`（v2.0）から取得
* 直近7日キーを生成し、存在するレコードのみ抽出

---

### UI

* result画面の「今日の記録」ブロックの下にテーブルを追加
* id例

  * `daily-history-table`（tbodyを差し替える方式）

---

### 追加機能（任意）

* 「直近7日」内での

  * bestAvgSec の最良（最小）を太字
  * worst（最大）を薄字

※ v2.1 では任意、まずは一覧を出せればOK

---

## v2.1 完了条件

* 結果画面に直近7日分のテーブルが表示される
* 記録がない日は表示されない
* 既存の v2.0（更新/差分/リセット）が壊れていない
* 既存の v1.0〜v1.8 の挙動が壊れていない

---

## v2.2：直近7日テーブルの強調＋合計行

### 概要

* v2.1 の直近7日テーブルを見やすくする

  1. bestAvgSec が最良（最小）の行を強調（太字）
  2. 直近7日（表示されている行）の attempt/wrong 合計を1行で表示

### 目的

* 「今週のベスト」と「今週の総量」が一目でわかる
* 授業・支援の振り返りに使いやすい

---

### 表示仕様

#### ① 最良行の強調

* テーブル内で bestAvgSec が最小の行に CSS クラス `is-best` を付与
* bestAvgSec が null の行は比較対象外（表示は0.0でも、強調対象にしない）

#### ② 合計行

* テーブルの下に合計表示を追加（表外のpでもOK）
* 合計対象は「表示されている行のみ」

  * attemptSum = Σ attemptTotal
  * wrongSum = Σ wrongTotal

表示例

* `直近7日合計：回答 320 / ミス 41`

---

### 実装方針

* resultScreen.enter() の描画時に

  * 抽出した records 配列から bestAvgSec の最小を求める
  * 行生成時に best 行へ `class="is-best"`
  * attemptSum/wrongSum を計算し、合計表示に反映

---

## v2.2 完了条件

* bestAvgSec の最良（最小）行が強調される
* 直近7日（表示行）の回答/ミス合計が表示される
* リセットで強調・合計表示も初期状態に戻る
* 既存の v2.0〜v2.1 の挙動が壊れていない

---

## v3.0：ランナー距離スコア（通常60秒モードのみ）

### 概要

* 通常プレイ（60秒モード）のスコアを「正解数」だけでなく **走行距離（m）**で表現する
* 画面下部に棒人間（ランナー）を表示し、**正解で速度UP／ミスで速度DOWN** する
* 復習モード（v1.5〜v1.6）は対象外（距離スコアなし）

### 目的

* 学習の反復を「目的あるゲーム」に変換し、集中と継続を促す
* 速度（平均秒/問）と精度（ミス）を、体感的に結びつける

---

### 仕様

#### ① 対象モード

* `gameState.isReviewMode === false` の通常プレイのみ

#### ② 追加ステート（gameState）

* `speedMps: 2.0`（初期速度 m/s）
* `distanceM: 0`（走行距離 m）
* `maxSpeedMps: 8.0`
* `minSpeedMps: 0.0`
* `speedUp: 0.3`（正解時）
* `speedDown: 0.6`（不正解時）
* `frictionMpsPerSec: 0.05`（自然減衰：毎秒 speed を減らす）

※ 値は v3.0 の初期値。後で調整可能。

#### ③ 距離更新（毎フレーム）

* gameScreen.update(dtMs) で

  * `dtSec = dtMs / 1000`
  * `speedMps = max(minSpeedMps, speedMps - frictionMpsPerSec * dtSec)`
  * `distanceM += speedMps * dtSec`
* 復習モード中は distance 更新しない（固定0）

#### ④ 正誤による速度変化

* 正解時（通常プレイのみ）

  * `speedMps = min(maxSpeedMps, speedMps + speedUp)`
* 不正解時（通常プレイのみ）

  * `speedMps = max(minSpeedMps, speedMps - speedDown)`

#### ⑤ 表示

* game画面に以下を追加

  * `距離: 123m`（小数なし or 1桁）
  * `速度: 3.2m/s`（小数1桁）
* 画面下部にランナー（棒人間）を表示

  * DOMベースでOK（canvas不要）
  * `runnerX = distanceM % trackLengthPx` のようにループ表示してよい

#### ⑥ 結果表示

* 通常プレイの結果画面に `距離` を表示
* 復習モード結果では距離を表示しない（または 0m 固定で非表示）

#### ⑦ 既存指標との関係

* 正解数/ミス/平均秒/問/モード別指標は既存のまま維持
* 距離は「追加スコア」として扱う

---

## v3.0 完了条件

* 通常プレイで距離と速度が表示され、正解で速度が上がりミスで下がる
* 60秒の間 distance が増加する
* 復習モードでは距離スコアが無効（更新されない）
* 結果画面に通常プレイの距離が表示される
* v1.0〜v2.2 の全機能が引き続き動作する

---

## v3.1：距離の保存（今日のベスト距離）

### 概要

* 通常プレイの距離スコアについて、**今日のベスト距離（最大）**を localStorage に保存する
* v2.x の日別統計（calcSprint.daily.v1）に統合して保持する（別キーに増やさない）

### 仕様

#### ① 保存先

* localStorage key: `calcSprint.daily.v1`（既存）
* 日別レコードに以下を追加

  * `bestDistanceM: number|null`

#### ② 更新タイミング

* `resultScreen.enter()` で日別統計を upsert する際に同時更新
* 更新条件（通常プレイのみ）

  * `gameState.isReviewMode === false`
  * `distanceM > 0`
  * 既存 bestDistanceM が null または `distanceM > bestDistanceM` のとき更新

#### ③ UI

* 結果画面に

  * 「今日のベスト距離」表示を追加（今日の記録ブロック内）
  * 通常プレイの結果には「今回の距離」も出る（v3.0）
* 昨日との差（任意）

  * bestDistanceM の差を `昨日との差` に追加してもよい（v3.1では任意）

#### ④ リセット

* v2.0 の「記録をリセット」で bestDistanceM も消える（同じキーのため自然）

---

## v3.1 完了条件

* 通常プレイの結果で、今日のベスト距離が更新される
* 復習モードの結果ではベスト距離は更新されない
* リセットでベスト距離表示が初期化される
* v2.0〜v2.2 の日別統計表示が壊れていない

---

## v3.2：直近7日テーブルにベスト距離列を追加

### 概要

* v2.1 の直近7日テーブルに `ベスト距離 (m)` 列を追加する
* v3.1 で保存した `bestDistanceM` を表示する

### 仕様

* テーブル列を以下に拡張

  * 日付 / ベスト平均 / ベスト距離 / 回答 / ミス
* bestDistanceM が null の場合は 0.0 表示でOK
* v2.2 の強調（is-best）は引き続き bestAvgSec に基づく（距離で強調しない）

### 完了条件

* 直近7日テーブルにベスト距離列が表示される
* リセットでテーブルが空になり表示が初期化される
* 既存の v2.0〜v3.1 の挙動が壊れていない

---

## v3.3：自己ベスト更新演出（ベスト平均/ベスト距離）

### 概要

* 結果画面で「今日のベスト平均」または「今日のベスト距離」が更新された場合に、短い演出を出す
* 演出は最小：

  * 文言（例："自己ベスト更新！"）
  * 1.5秒程度で自動で消える

### 仕様

* 判定タイミング：resultScreen.enter()
* 判定方法（最小）

  * upsert 前の todayRecord（旧）と upsert 後の todayRecord（新）を比較
  * bestAvgSec が改善（小さくなった）または bestDistanceM が増加した場合、演出を出す
* UI

  * 結果画面にメッセージ領域（id例：`result-best-toast`）を追加
  * 通常は hidden
  * 更新があった場合のみ表示し、setTimeoutで隠す

### 完了条件

* ベスト更新が発生した場合のみ演出が出る
* 1.5秒程度で自動的に消える
* リセットや画面遷移で演出が残らない
* 既存の v1.0〜v3.2 の挙動が壊れていない

---

## v3.4：距離ベスト行の強調＋直近7日距離合計

### 概要

* 直近7日テーブルで

  1. **ベスト平均（最小）行**の強調に加えて
  2. **ベスト距離（最大）行**も別の強調で示す
* さらに、直近7日（表示行）の **ベスト距離合計** を表示する

### 仕様

#### ① 行強調

* 既存：bestAvgSec 最小行 → `is-best`（太字）
* 追加：bestDistanceM 最大行 → `is-best-distance`

  * bestDistanceM が number の行のみ比較対象（nullは除外）
  * 最大が複数ある場合は最も新しい日（上の行）を優先

#### ② 合計表示

* 既存：`直近7日合計：回答 X / ミス Y`
* 追加：距離合計（表示行のみ）

  * `distanceSum = Σ bestDistanceM`（nullは0扱いで加算してよい）

表示例

* `直近7日合計：回答 320 / ミス 41 / 距離 1543.2m`

#### ③ リセット連動

* リセット後は

  * テーブル空
  * 合計表示が `回答 0 / ミス 0 / 距離 0.0m`
  * 強調クラスが残らない

#### ④ CSS

* `is-best-distance` は色や下線などで `is-best` と区別

  * 例：薄い青背景／枠線

### 完了条件

* 直近7日テーブルで距離ベスト行が強調される
* 合計表示に距離合計が追加される
* リセットで表示が初期化される
* 既存の v2.x〜v3.3 の挙動が壊れていない
