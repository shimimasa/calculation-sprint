# ADR-007: アセット/ルーティングの統合耐性ゲート（HTML誤配信検知・404診断・ログ規約）

Status: Accepted
Date: 2026-02-07

## Context

- 統合先で SPA の rewrite が有効になっていると、アセット URL に対して `text/html` が返る事故が起きる。
- 404 と HTML 誤配信は見た目が似ており、現場で原因の切り分けが難しい。
- 最小の差分で「一度だけ警告し、原因推測を残す」仕組みが必要。

## Decision

1. **アセット取得の診断を共通ユーティリティに集約**する。
   - `src/core/assetDiagnostics.js` を正本とする。
2. **`text/html` が返ったアセット URL は URL ごとに 1 回だけ warn** する。
   - `Content-Type: text/html` を検知した場合に警告する。
3. **404 を検知した場合も URL ごとに 1 回だけ warn** する。
4. **警告ログには原因推測（basepath/rewrites）に必要な情報を最小で含める**。
   - `requestedUrl` / `status` / `contentType` / `appPath` を含める。
   - ヒントとして「サブパス配信/SPA rewrite が疑われる」旨を明記する。

## Non-goals

- 取得リトライや自動復旧の実装。
- 画像キャッシュの最適化や読み込み戦略の刷新。

## Consequences

- 得るもの: 誤配信/404 の一次切り分けができる。
- 失うもの: 追加ログが増える（ただし URL ごとに 1 回のみ）。

## References

- spec/adr/ADR-004.md
- spec/tech-spec.md
- spec/test-results/adr-acceptance-latest.md
