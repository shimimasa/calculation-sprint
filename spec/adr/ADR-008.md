# ADR-008: ストレージ/プロファイルの完全分離ゲート（キー規約・移行・破壊的変更の扱い）

Status: Accepted
Date: 2026-02-07

## Context

- 既存の storage 名前空間は複数（`calcSprint.*` / `portal.calcSprint.*`）が混在している。
- 統合先での混在・上書きを避けるため、プロファイル分離の規約を強制したい。
- 既存データの扱いを曖昧にすると運用が揺れる。

## Decision

1. **storage キーは `calc-sprint::<profileId>::<storeName>.<version>` に統一**する。
   - メタキーは `calc-sprint::meta::<key>` に固定する。
2. **プロファイル分離は常に `profileId` を明示して行う**。
   - `src/core/storageKeys.js` の `makeKey`/`resolveProfileId` を正本とする。
3. **既存キーの移行は「デフォルトプロファイルのみ・コピー移行（非破壊）」に統一**する。
   - `portal.calcSprint.*` と `calcSprint.*` を legacy とみなし、最初の読み出し時に新キーへコピーする。
   - 移行済みフラグは `calc-sprint::meta::migration::<storeName>.<version>` に記録する。

## Non-goals

- profileId の命名規則追加（A〜H 以外の管理）。
- 旧キーの自動削除や一括クリーニング。

## Consequences

- 得るもの: 統合先でのキー衝突リスクが大幅に減る。
- 失うもの: 旧キーを残すため localStorage に冗長データが残る。

## References

- spec/adr/ADR-002.md
- spec/adr/ADR-004.md
- spec/tech-spec.md
- spec/test-results/adr-acceptance-latest.md
